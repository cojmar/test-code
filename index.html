<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>GPS Route Tracker with Change Detection</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
  html, body { margin: 0; padding: 0; height: 100%; }
  #map { width: 100%; height: 100%; }

  #controls {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 9999;
    display: flex;
    gap: 10px;
  }

  button {
    padding: 7px 12px;
    font-size: 14px;
    border: none;
    background: #222;
    color: white;
    cursor: pointer;
    border-radius: 4px;
  }

  button:hover {
    background: #444;
  }
</style>
</head>

<body>

<div id="controls">
    <button id="exportBtn">Export</button>
    <button id="importBtn">Import</button>
    <input type="file" id="fileInput" style="display:none" />
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// ---------------- MAP + GPS ----------------
const map = L.map('map').setView([0, 0], 19);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

let route = [];
let marker = L.marker([0,0]); // placeholder
let polyline = L.polyline([], { color: "red" }).addTo(map);

let lastPoint = null;
const THRESHOLD = 0.00001; // ~1 meter

navigator.geolocation.watchPosition(
    pos => {
        const { latitude, longitude } = pos.coords;

        // Store new point only if moved enough
        if (!lastPoint ||
            Math.abs(latitude - lastPoint.lat) > THRESHOLD ||
            Math.abs(longitude - lastPoint.lon) > THRESHOLD) {

            const timestamp = Date.now();
            const point = { lat: latitude, lon: longitude, time: timestamp };

            route.push(point);
            lastPoint = point;

            polyline.setLatLngs(route.map(p => [p.lat, p.lon]));

            if (!marker._map) {
                marker = L.marker([point.lat, point.lon]).addTo(map);
                map.setView([point.lat, point.lon], 19);
            } else {
                marker.setLatLng([point.lat, point.lon]);
            }
        }
    },
    err => console.error("GPS Error:", err),
    { enableHighAccuracy: true }
);

// ---------------- EXPORT ----------------
document.getElementById("exportBtn").onclick = () => {
    const data = JSON.stringify(route, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "route.txt";
    a.click();

    URL.revokeObjectURL(url);
};

// ---------------- IMPORT ----------------
document.getElementById("importBtn").onclick = () => {
    document.getElementById("fileInput").click();
};

document.getElementById("fileInput").onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const text = await file.text();

    try {
        const arr = JSON.parse(text);

        if (!Array.isArray(arr)) {
            alert("Invalid route file");
            return;
        }

        // Ensure each point has lat, lon, time
        route = arr.map(p => ({
            lat: p.lat,
            lon: p.lon,
            time: p.time || Date.now()
        }));

        lastPoint = route.length > 0 ? route[route.length - 1] : null;

        polyline.setLatLngs(route.map(p => [p.lat, p.lon]));

        if (route.length > 0) {
            const last = route[route.length - 1];

            if (!marker._map) marker = L.marker([last.lat, last.lon]).addTo(map);
            marker.setLatLng([last.lat, last.lon]);
            map.setView([last.lat, last.lon], 19);
        }

    } catch (err) {
        alert("Error loading route");
        console.error(err);
    }
};
</script>

</body>
</html>
