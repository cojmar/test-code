<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>GPS Route Tracker Desktop & Mobile</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
  html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
  #map { width: 100%; height: 100%; }

  #controls {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: rgba(0,0,0,0.5);
    padding: 10px;
    border-radius: 8px;
  }

  button {
    padding: 12px 16px;
    font-size: 18px;
    border: none;
    background: #222;
    color: white;
    cursor: pointer;
    border-radius: 6px;
  }

  button:hover { background: #444; }

  #statsPanel {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #fff;
    font-size: 24px;
    font-weight: bold;
    padding: 15px 25px;
    border-radius: 12px;
    z-index: 9999;
    text-align: center;
    min-width: 220px;
  }

  @media (max-width: 500px) {
    button { font-size: 16px; padding: 10px 14px; }
    #statsPanel { font-size: 20px; padding: 12px 20px; min-width: 180px; }
  }

  .leaflet-control-container{ display: none !important; }
</style>
</head>

<body>

<div id="controls">
    <button id="exportBtn">Export</button>
    <button id="importBtn">Import</button>
    <button id="clearBtn">Clear</button>
    <input type="file" id="fileInput" style="display:none" />
</div>

<div id="statsPanel">Distance: 0 m | Time: 0 s</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const isMobile = /Mobi|Android/i.test(navigator.userAgent)
const mZoom = isMobile ? 20 : 18
const map = L.map('map').setView([0,0], mZoom)

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 22 }).addTo(map)
map.on('tileerror', () => { map.eachLayer(l => { if(l instanceof L.TileLayer) l.redraw(); }) })

let route = JSON.parse(localStorage.getItem("gpsRoute") || "[]")
let marker = null
let polyline = L.polyline([], { color: "red" }).addTo(map)
let lastPoint = route.length ? route[route.length-1] : null
const THRESHOLD = 0.00001
const statsDiv = document.getElementById("statsPanel")

function distanceMeters(p1,p2){
    const R=6371000
    const dLat=(p2.lat-p1.lat)*Math.PI/180
    const dLon=(p2.lon-p1.lon)*Math.PI/180
    const lat1=p1.lat*Math.PI/180
    const lat2=p2.lat*Math.PI/180
    const a=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))
    return R*c
}

function updateStats(){
    if(route.length<2){ statsDiv.textContent="Distance: 0 m | Time: 0 s"; return }
    let dist=0
    for(let i=1;i<route.length;i++) dist+=distanceMeters(route[i-1],route[i])
    const elapsed=Math.floor((route[route.length-1].time-route[0].time)/1000)
    statsDiv.textContent=`Distance: ${dist.toFixed(1)} m | Time: ${elapsed} s`
}

// ---------------- WAKE LOCK ----------------
let wakeLock = null;
async function requestWakeLock(){
    if('wakeLock' in navigator){
        try{
            wakeLock = await navigator.wakeLock.request('screen')
            wakeLock.addEventListener('release',()=>{console.log('Wake Lock released')})
        }catch(e){console.warn("Wake lock failed:",e)}
    }
}
document.addEventListener('click', requestWakeLock, {once:true})
document.addEventListener('visibilitychange', ()=>{if(wakeLock===null&&!document.hidden) requestWakeLock()})

// ---------------- GEOLOCATION ----------------
function addPoint(lat, lon){
    const timestamp=Date.now()
    const point={lat,lon,time:timestamp}
    route.push(point)
    lastPoint=point
    localStorage.setItem("gpsRoute", JSON.stringify(route))
    polyline.setLatLngs(route.map(p=>[p.lat,p.lon]))
    if(!marker){ marker=L.marker([lat,lon]).addTo(map); map.setView([lat,lon], mZoom); setTimeout(()=>map.invalidateSize(),200) }
    else marker.setLatLng([lat,lon])
    updateStats()
}

function handlePosition(pos){
    const {latitude,longitude}=pos.coords
    if(!lastPoint||Math.abs(latitude-lastPoint.lat)>THRESHOLD||Math.abs(longitude-lastPoint.lon)>THRESHOLD) addPoint(latitude,longitude)
}

function fallbackLocate(){
    map.locate({setView:true,maxZoom:15,watch:false}).on('locationfound', e=>{ if(!lastPoint) addPoint(e.latitude,e.longitude) })
}

function startTracking(){
    if(!navigator.geolocation){ fallbackLocate(); return }
    // active GPS request
    navigator.geolocation.getCurrentPosition(
        pos=>handlePosition(pos),
        err=>{ console.warn("Initial GPS failed, fallback to IP:",err); fallbackLocate() },
        { enableHighAccuracy:true, timeout:10000 }
    )
    navigator.geolocation.watchPosition(
        pos=>handlePosition(pos),
        err=>{ console.warn("Watch GPS error:",err); fallbackLocate() },
        { maximumAge:0, enableHighAccuracy:true }
    )
}

// ---------------- INITIALIZE ----------------
polyline.setLatLngs(route.map(p=>[p.lat,p.lon]))
if(route.length){
    const last=route[route.length-1]
    marker=L.marker([last.lat,last.lon]).addTo(map)
    map.setView([last.lat,last.lon], mZoom)
    setTimeout(()=>map.invalidateSize(),200)
}
updateStats()
startTracking()
window.addEventListener("load",()=>map.invalidateSize())

// ---------------- EXPORT ----------------
document.getElementById("exportBtn").onclick=()=>{
    const data=JSON.stringify(route,null,2)
    const blob=new Blob([data],{type:"application/json"})
    const url=URL.createObjectURL(blob)
    const a=document.createElement("a")
    a.href=url
    a.download="route.txt"
    a.click()
    URL.revokeObjectURL(url)
}

// ---------------- IMPORT ----------------
document.getElementById("importBtn").onclick=()=>document.getElementById("fileInput").click()
document.getElementById("fileInput").onchange=async e=>{
    const file=e.target.files[0]; if(!file) return
    const text=await file.text()
    try{
        const arr=JSON.parse(text)
        if(!Array.isArray(arr)){ alert("Invalid route file"); return }
        route=arr.map(p=>({lat:p.lat,lon:p.lon,time:p.time||Date.now()}))
        lastPoint=route.length?route[route.length-1]:null
        localStorage.setItem("gpsRoute", JSON.stringify(route))
        polyline.setLatLngs(route.map(p=>[p.lat,p.lon]))
        if(route.length){
            const last=route[route.length-1]
            if(!marker) marker=L.marker([last.lat,last.lon]).addTo(map)
            marker.setLatLng([last.lat,last.lon])
            map.setView([last.lat,last.lon], mZoom)
            setTimeout(()=>map.invalidateSize(),200)
        }
        updateStats()
    }catch(err){ alert("Error loading route"); console.error(err) }
}

// ---------------- CLEAR ----------------
document.getElementById("clearBtn").onclick=()=>{
    localStorage.removeItem("gpsRoute")
    location.reload()
}
</script>

</body>
</html>
