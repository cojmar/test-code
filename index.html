<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>GPS Route Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
#map { width:100%; height:100%; }

#controls {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: rgba(0,0,0,0.5);
  padding: 10px;
  border-radius: 8px;
}

button {
  padding: 12px 16px;
  font-size: 18px;
  border: none;
  background: #222;
  color: white;
  cursor: pointer;
  border-radius: 6px;
}

button:hover { background: #444; }

#statsPanel {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color: #fff;
  font-size: 24px;
  font-weight: bold;
  padding: 15px 25px;
  border-radius: 12px;
  z-index: 9999;
  text-align: center;
  min-width: 220px;
}

@media (max-width: 500px) {
  button { font-size: 16px; padding: 10px 14px; }
  #statsPanel { font-size: 20px; padding: 12px 20px; min-width: 180px; }
}

/* Hide Leaflet logo and default controls */
.leaflet-control-container { display: none !important; }
.leaflet-bottom.leaflet-left { display: none !important; }

</style>
</head>

<body>
<audio id="bgAudio" loop>
  <source src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAA..." type="audio/mpeg">
</audio>

<div id="controls">
  <button id="exportBtn">Export</button>
  <button id="importBtn">Import</button>
  <button id="clearBtn">Clear Data</button>
  <input type="file" id="fileInput" style="display:none" />
</div>

<div id="statsPanel">Distance: 0 m | Time: 0 s</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// ---------------- BACKGROUND AUDIO & WAKE LOCK ----------------
const bgAudio = document.getElementById('bgAudio');
let audioStarted = false;
let wakeLock = null;

async function startAudioAndWakeLock() {
    if (!audioStarted) {
        bgAudio.play().catch(err => console.warn("Audio autoplay blocked:", err));
        audioStarted = true;
    }
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lock acquired');
            wakeLock.addEventListener('release', () => {
                console.log('Wake Lock released, reacquiring...');
                startAudioAndWakeLock();
            });
        } else {
            console.warn('Wake Lock API not supported on this browser.');
        }
    } catch(err) { console.error('Could not acquire Wake Lock:', err); }
}

// Must be triggered by user interaction
document.addEventListener('click', startAudioAndWakeLock);
document.addEventListener('touchstart', startAudioAndWakeLock);

// ---------------- MAP ----------------
const mZoom = 18;
const map = L.map('map').setView([0,0], mZoom);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:mZoom}).addTo(map);

// ---------------- ROUTE ----------------
let route = [];
let lastPoint = null;
const THRESHOLD = 0.00001;
const statsDiv = document.getElementById("statsPanel");
let polyline = L.polyline([], { color: "red" }).addTo(map);
let marker = null;

// ---------------- STORAGE ----------------
function saveRouteToStorage() {
    localStorage.setItem("routeData", JSON.stringify(route));
}

function loadRouteFromStorage() {
    const stored = localStorage.getItem("routeData");
    if(stored){
        try{
            const arr = JSON.parse(stored);
            if(Array.isArray(arr)){
                route = arr.map(p=>({lat:p.lat, lon:p.lon, time:p.time||Date.now()}));
                lastPoint = route.length ? route[route.length-1] : null;
                polyline.setLatLngs(route.map(p=>[p.lat,p.lon]));
                if(route.length) {
                    map.setView([lastPoint.lat,lastPoint.lon], mZoom);
                    marker = L.marker([lastPoint.lat,lastPoint.lon]).addTo(map);
                }
                updateStats();
            }
        } catch(err){console.error("Failed to load route from storage:",err);}
    }
}

function clearRouteStorage(){
    localStorage.removeItem("routeData");
    route=[]; lastPoint=null; polyline.setLatLngs([]);
    if(marker){ map.removeLayer(marker); marker=null; }
    updateStats();
}

// ---------------- STATS ----------------
function distanceMeters(p1,p2){
    const R=6371000;
    const dLat=(p2.lat-p1.lat)*Math.PI/180;
    const dLon=(p2.lon-p1.lon)*Math.PI/180;
    const lat1=p1.lat*Math.PI/180;
    const lat2=p2.lat*Math.PI/180;
    const a=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
}

function updateStats(){
    if(route.length<2){ statsDiv.textContent="Distance: 0 m | Time: 0 s"; return; }
    let dist=0;
    for(let i=1;i<route.length;i++) dist+=distanceMeters(route[i-1],route[i]);
    const elapsed=Math.floor((route[route.length-1].time-route[0].time)/1000);
    statsDiv.textContent=`Distance: ${dist.toFixed(1)} m | Time: ${elapsed} s`;
}

// ---------------- GEOLOCATION ----------------
map.locate({ setView:true, maxZoom:mZoom, watch:true, enableHighAccuracy:true })
   .on('locationfound', e=>{
       const {lat,lng}=e;
       if(!lastPoint || Math.abs(lat-lastPoint.lat)>THRESHOLD || Math.abs(lng-lastPoint.lon)>THRESHOLD){
           const point={lat, lon:lng, time:Date.now()};
           route.push(point);
           lastPoint=point;
           polyline.setLatLngs(route.map(p=>[p.lat,p.lon]));
           updateStats();
           saveRouteToStorage();

           // ----- MARKER -----
           if(!marker){
               marker = L.marker([lat,lng]).addTo(map);
               // Mobile: zoom closer on first fix
               if (/Mobi|Android/i.test(navigator.userAgent)) map.setZoom(20);
           } else {
               marker.setLatLng([lat,lng]);
           }
       }
   })
   .on('locationerror', e=>console.warn("Location error:",e));

// ---------------- EXPORT ----------------
document.getElementById("exportBtn").onclick=()=>{
    const data=JSON.stringify(route,null,2);
    const blob=new Blob([data],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="route.txt"; a.click();
    URL.revokeObjectURL(url);
}

// ---------------- IMPORT ----------------
document.getElementById("importBtn").onclick=()=>document.getElementById("fileInput").click();

document.getElementById("fileInput").onchange=async e=>{
    const file=e.target.files[0]; if(!file) return;
    const text=await file.text();
    try{
        const arr=JSON.parse(text);
        if(!Array.isArray(arr)){alert("Invalid route file");return;}
        route=arr.map(p=>({lat:p.lat, lon:p.lon, time:p.time||Date.now()}));
        lastPoint=route.length?route[route.length-1]:null;
        polyline.setLatLngs(route.map(p=>[p.lat,p.lon]));
        if(route.length){
            if(!marker) marker = L.marker([lastPoint.lat,lastPoint.lon]).addTo(map);
            marker.setLatLng([lastPoint.lat,lastPoint.lon]);
            map.setView([lastPoint.lat,lastPoint.lon], mZoom);
            // Mobile zoom adjustment
            if (/Mobi|Android/i.test(navigator.userAgent)) map.setZoom(20);
        }
        updateStats();
        saveRouteToStorage();
    } catch(err){alert("Error loading route"); console.error(err);}
}

// ---------------- CLEAR ----------------
document.getElementById("clearBtn").onclick=()=>{
    if(confirm("Clear all route data?")) clearRouteStorage();
}

// Load stored route on start
loadRouteFromStorage();
</script>

</body>
</html>
