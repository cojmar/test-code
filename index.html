<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>GPS Route Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    #controls {
        position: fixed;
        top: 5px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 9999;
    }

    #controls button {
        font-size: 18px;
        padding: 12px 20px;
        min-width: 110px;
    }

    @media (max-width: 600px) {
        #controls button {
            font-size: 20px;
            padding: 16px 24px;
            min-width: 130px;
        }
    }

    #followBox {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 6px 12px;
        border-radius: 8px;
        z-index: 9999;
        font-size: 18px;
    }
</style>
</head>
<body>

<div id="controls">
    <button id="btnExport">Export</button>
    <button id="btnImport">Import</button>
</div>

<div id="followBox">
    <label>
        <input type="checkbox" id="followCheckbox"> Follow Me
    </label>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* =======================
   STORAGE / VARIABLES
======================= */

let route = JSON.parse(localStorage.getItem("route") || "[]");
let followMode = localStorage.getItem("followMode") === "true";
let savedZoom = Number(localStorage.getItem("savedZoom") || 18);

/* =======================
   IMPORT FROM HASH
======================= */

function importFromHash() {
    if (location.hash.length > 1) {
        try {
            const b64 = location.hash.substring(1);
            const json = atob(b64);
            const data = JSON.parse(json);

            if (Array.isArray(data.route)) route = data.route;
            if (typeof data.follow !== "undefined") followMode = data.follow;
            if (typeof data.zoom !== "undefined") savedZoom = data.zoom;

            history.replaceState(null, "", location.pathname);
        } catch (e) {
            console.log("Bad hash", e);
            history.replaceState(null, "", location.pathname);
        }
    }
}

importFromHash();

/* =======================
   MAP INIT
======================= */

const map = L.map('map').setView([0,0], savedZoom);

map.on("zoomend", () => {
    localStorage.setItem("savedZoom", map.getZoom());
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 22
}).addTo(map);

/* =======================
   POLYLINE
======================= */

const polyline = L.polyline(route, {
    color: "green",
    weight: 6,
    opacity: 0.9,
    smoothFactor: 1,
    className: "route-line"
}).addTo(map);

// Add blue outline
polyline.setStyle({
    color: "green",
    weight: 6
});
polyline.bringToFront();

const outline = L.polyline(route, {
    color: "blue",
    weight: 10,
    opacity: 0.5
}).addTo(map);
outline.bringToBack();

/* =======================
   MARKER
======================= */

let marker = L.marker([0,0]).addTo(map);

/* =======================
   FOLLOW CHECKBOX
======================= */

document.getElementById("followCheckbox").checked = followMode;

document.getElementById("followCheckbox").addEventListener("change", e => {
    followMode = e.target.checked;
    localStorage.setItem("followMode", followMode);
});

/* =======================
   GPS WATCH
======================= */

if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        marker.setLatLng([lat, lon]);

        route.push([lat, lon]);
        localStorage.setItem("route", JSON.stringify(route));

        polyline.setLatLngs(route);
        outline.setLatLngs(route);

        if (followMode) {
            map.setView([lat, lon], map.getZoom());
        }
    }, err => {
        console.log("GPS error", err);
    }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
    });
}

/* =======================
   EXPORT BASE64 URL
======================= */

function exportRoute() {
    const data = {
        route: route,
        follow: followMode,
        zoom: map.getZoom()
    };

    const json = JSON.stringify(data);
    const b64 = btoa(json);

    const exportUrl = location.origin + location.pathname + "#" + b64;

    navigator.clipboard.writeText(exportUrl)
        .then(() => alert("Copied to clipboard"))
        .catch(() => alert("Clipboard error"));
}

/* =======================
   IMPORT BUTTON
======================= */

function importRoute() {
    const hash = prompt("Paste URL with hash:");
    if (!hash) return;

    if (hash.includes("#")) {
        location.href = hash;
        location.reload();
    } else {
        alert("Invalid link");
    }
}

/* =======================
   BUTTON EVENTS
======================= */

document.getElementById("btnExport").onclick = exportRoute;
document.getElementById("btnImport").onclick = importRoute;

</script>
</body>
</html>
