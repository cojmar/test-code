<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>GPS Route Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
  html, body {
    margin:0; padding:0; height:100%;
    font-family:sans-serif;
  }
  #map {
    width:100%; height:100%;
    transform: scale(1.4);          /* MAP BIGGER */
    transform-origin: center center;
  }

  #controls {
    position:absolute;
    top:10px; left:50%;
    transform:translateX(-50%);
    display:flex;
    flex-direction:row;
    gap:8px;
    z-index:9999;
    background:rgba(0,0,0,0.35);
    padding:6px 10px;
    border-radius:10px;
    backdrop-filter:blur(3px);
  }

  button {
    font-size:18px;
    padding:10px 18px;
    border:none;
    background:#222;
    color:white;
    border-radius:8px;
  }

  /* BIGGER BUTTONS ON MOBILE */
  @media (max-width:800px) {
    button {
      font-size:22px;
      padding:16px 26px;
    }
  }

  #followBox {
    display:flex;
    align-items:center;
    gap:6px;
    color:white;
    font-size:18px;
  }
</style>
</head>
<body>

<div id="controls">
  <button id="btnStart">Start</button>
  <button id="btnStop">Stop</button>
  <div id="followBox">
    <input type="checkbox" id="chkFollow" />
    Follow Me
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* -----------------------------------------
   LOAD SETTINGS
------------------------------------------ */
let savedZoom = localStorage.getItem("zoom");
if (savedZoom) savedZoom = Number(savedZoom); else savedZoom = 18;

let followSetting = localStorage.getItem("follow");
if (followSetting === null) followSetting = "on";

document.getElementById("chkFollow").checked = (followSetting === "on");

/* -----------------------------------------
   MAP
------------------------------------------ */
const map = L.map("map", {
  zoomControl: true,
  maxZoom: 25,      // FIX GREY TILE
  minZoom: 1
}).setView([0,0], savedZoom);

/* High-zoom tiles */
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 25
}).addTo(map);

/* -----------------------------------------
   POLYLINE (GREEN + THICK)
------------------------------------------ */
const route = L.polyline([], {
  color:"lime",
  weight:8,
  opacity:1
}).addTo(map);

/* -----------------------------------------
   USER MARKER (DEFAULT)
------------------------------------------ */
let marker = L.marker([0,0]).addTo(map);

/* -----------------------------------------
   ZOOM SAVE
------------------------------------------ */
map.on("zoomend", () => {
  localStorage.setItem("zoom", map.getZoom());
});

/* force reload tiles after setting zoom on load */
setTimeout(()=>{ map.invalidateSize(true); }, 500);

/* -----------------------------------------
   FOLLOW MODE SAVE
------------------------------------------ */
document.getElementById("chkFollow").addEventListener("change", () => {
  localStorage.setItem("follow",
    document.getElementById("chkFollow").checked ? "on" : "off"
  );
});

/* -----------------------------------------
   GPS
------------------------------------------ */
let watchID = null;

function startGPS() {
  if (watchID !== null) return;

  watchID = navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      marker.setLatLng([lat, lon]);
      route.addLatLng([lat, lon]);

      if (document.getElementById("chkFollow").checked) {
        map.setView([lat, lon], map.getZoom(), {animate:false});
      }
    },
    err => console.log("GPS error:", err),
    { enableHighAccuracy: true, maximumAge:1000, timeout:15000 }
  );
}

function stopGPS() {
  if (watchID !== null) {
    navigator.geolocation.clearWatch(watchID);
    watchID = null;
  }
}

/* -----------------------------------------
   BUTTON EVENTS
------------------------------------------ */
document.getElementById("btnStart").onclick = startGPS;
document.getElementById("btnStop").onclick = stopGPS;

/* start following by default */
if (followSetting === "on") startGPS();
</script>
</body>
</html>
